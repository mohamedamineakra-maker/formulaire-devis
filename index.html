<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire Devis - ETS Saunier</title>
    <style>
        /* RESET CSS */
        #saunier-form-container * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }

        #saunier-form-container {
            all: initial;
            display: block;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        #saunier-form-container .form-card {
            background: white;
            border-radius: 16px;
            padding: 20px 15px; /* Padding r√©duit par d√©faut pour gagner de la place */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }

        /* --- HEADER --- */
        #saunier-form-container .form-header { margin-bottom: 15px; }
        #saunier-form-container .form-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B35 0%, #FF5722 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(255, 87, 34, 0.2);
        }
        #saunier-form-container .form-title {
            font-size: 22px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 4px;
            line-height: 1.1;
        }
        #saunier-form-container .form-subtitle { font-size: 12px; color: #666; }

        /* --- LOGIQUE D'AFFICHAGE (STEPS) --- */
        #saunier-form-container .step { display: none; }
        #saunier-form-container .step.active { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRILLE FORCEE (C'est ici que √ßa se joue) --- */
        
        /* 1. CONFIGURATION PAR D√âFAUT (PC / SIDEBAR) -> FORCE 3 COLONNES */
        #saunier-form-container .quantities-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr) !important; /* FORCE 3 */
            gap: 6px; /* Ecart minimal */
            margin-bottom: 15px;
        }

        #saunier-form-container .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr) !important; /* FORCE 3 */
            gap: 6px;
        }

        /* Style compact pour que √ßa rentre partout */
        #saunier-form-container .quantity-item {
            background: #fafafa;
            border: 1.5px solid #e8e8e8;
            border-radius: 10px;
            padding: 8px 4px;
            text-align: center;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            min-height: 115px; /* Hauteur compacte */
        }

        #saunier-form-container .quantity-item.selected { border-color: #FF5722; background: #FFF5F2; }
        #saunier-form-container .quantity-item:hover { border-color: #FF5722; background: #fff; }

        /* Icones compactes */
        #saunier-form-container .quantity-icon {
            color: #FF5722;
            margin-bottom: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }
        #saunier-form-container .quantity-icon svg { width: 32px; height: 32px; }

        /* Textes compacts */
        #saunier-form-container .quantity-label {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 10px; /* Texte petit pour √©viter le retour √† la ligne */
            margin-bottom: 6px;
            line-height: 1.1;
            min-height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Boutons compacts */
        #saunier-form-container .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: auto;
        }
        #saunier-form-container .qty-btn {
            width: 24px;
            height: 24px;
            min-width: 24px;
            min-height: 24px;
            border: 1.5px solid #e8e8e8;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            color: #FF5722;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        #saunier-form-container .qty-btn:hover { background: #FF5722; color: white; }
        #saunier-form-container .quantity-controls input {
            width: 26px;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            border: none;
            padding: 0;
            background: transparent;
        }

        /* Options (Checkboxes) Compactes */
        #saunier-form-container .option-card {
            border: 1.5px solid #e8e8e8;
            border-radius: 10px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            background: #fafafa;
            position: relative;
        }
        #saunier-form-container .option-card.selected { border-color: #FF5722; background: #FFF5F2; }
        #saunier-form-container .option-card input { position: absolute; opacity: 0; }
        #saunier-form-container .option-card .icon { font-size: 24px; margin-bottom: 4px; color: #FF5722; }
        #saunier-form-container .option-card .icon svg { width: 32px; height: 32px; }
        #saunier-form-container .option-card .title { font-weight: 600; font-size: 10px; margin-bottom: 0; }
        #saunier-form-container .option-card .description { font-size: 9px; color: #666; display: none; } /* On cache la description pour gagner de la place */

        /* --- FORM ELEMENTS GENERIC --- */
        #saunier-form-container .form-group { margin-bottom: 12px; }
        #saunier-form-container label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; }
        #saunier-form-container input[type="text"],
        #saunier-form-container input[type="email"],
        #saunier-form-container input[type="tel"],
        #saunier-form-container select,
        #saunier-form-container textarea {
            width: 100%; padding: 10px; border: 1.5px solid #e0e0e0; border-radius: 8px; font-size: 13px;
        }
        #saunier-form-container .btn {
            width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;
        }
        #saunier-form-container .btn-primary { background: #FF5722; color: white; display: flex; justify-content: center; gap: 8px; }
        #saunier-form-container .btn-secondary { background: #f5f5f5; color: #333; width: auto; }
        #saunier-form-container .buttons { display: flex; gap: 8px; margin-top: 15px; }
        
        /* Error & Success */
        #saunier-form-container .error-message { color: #f44336; font-size: 10px; display: none; }
        #saunier-form-container .form-group.error input { border-color: #f44336; }
        #saunier-form-container .form-group.error .error-message { display: block; }
        #saunier-form-container .step-error-message { background: #ffebee; color: #f44336; padding: 10px; border-radius: 6px; font-size: 12px; margin-top: 10px; display: none; }

        /* Progress Bar */
        #saunier-form-container .progress-container { margin-bottom: 15px; }
        #saunier-form-container .progress-bar-wrapper { width: 100%; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 5px; }
        #saunier-form-container .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #FF6B35 0%, #FF5722 100%); width: 0%; transition: width 0.4s ease; }
        #saunier-form-container .progress-text { text-align: right; font-size: 10px; color: #999; font-weight: 600; }
        #saunier-form-container .step-indicator { text-align: center; color: #999; font-size: 11px; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }

        /* Footer */
        #saunier-form-container .form-footer { display: flex; justify-content: center; gap: 8px; margin-top: 15px; font-size: 10px; color: #aaa; }
        #saunier-form-container .form-footer svg { width: 12px; height: 12px; vertical-align: text-bottom; }

        /* Upload */
        #saunier-form-container .file-upload-wrapper { border: 2px dashed #ddd; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; }
        #saunier-form-container .uploaded-file { font-size: 11px; background: #f0f0f0; padding: 5px; margin-top: 5px; border-radius: 4px; display: flex; justify-content: space-between; }

        /* Recap */
        #saunier-form-container .recap-section { background: #f9f9f9; padding: 15px; border-radius: 10px; font-size: 12px; margin-bottom: 15px; }
        #saunier-form-container .recap-item { margin-bottom: 5px; display: flex; gap: 5px; }
        #saunier-form-container .recap-edit { color: #FF5722; text-decoration: underline; cursor: pointer; display: block; margin-top: 5px; }

        /* 2. OVERRIDE MOBILE (Uniquement sur vrais petits √©crans) -> FORCE 2 COLONNES */
        @media (max-width: 480px) {
            #saunier-form-container .quantities-grid {
                grid-template-columns: repeat(2, 1fr) !important; /* FORCE 2 sur mobile */
            }
            #saunier-form-container .options-grid {
                grid-template-columns: repeat(2, 1fr) !important; /* FORCE 2 sur mobile */
            }
            #saunier-form-container .buttons {
                position: sticky; bottom: 0; background: white; margin: 0 -15px -20px -15px; padding: 15px; border-top: 1px solid #eee; z-index: 10;
            }
        }
    </style>
</head>
<body>
    <div id="saunier-form-container">
        <div class="form-card">
            <div class="form-header">
                <div class="form-badge">üìã DEVIS GRATUIT</div>
                <h2 class="form-title">Votre projet</h2>
                <p class="form-subtitle">Configuration en 2 min</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>
                <div class="progress-text" id="progressText">17%</div>
            </div>

            <form id="devisForm">
                <input type="text" name="_honeypot" style="display:none !important" tabindex="-1" autocomplete="off">

                <div class="step active" data-step="1">
                    <div class="step-indicator">1. Menuiseries</div>
                    <div class="quantities-grid">
                        <div class="quantity-item" data-type="fenetres">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="12" y="8" width="40" height="48" rx="3" fill="#FFE5E0" stroke="currentColor" stroke-width="2"/><line x1="32" y1="8" x2="32" y2="56" stroke="currentColor" stroke-width="2"/><line x1="12" y1="32" x2="52" y2="32" stroke="currentColor" stroke-width="2"/><circle cx="40" cy="32" r="2" fill="currentColor"/></svg>
                            </div>
                            <div class="quantity-label">Fen√™tre</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="fenetres">‚àí</button>
                                <input type="number" name="qty_fenetres" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="fenetres">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="portefenetres">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="12" y="8" width="40" height="48" rx="3" fill="#FFE5E0" stroke="currentColor" stroke-width="2"/><path d="M32 8v48" stroke="currentColor" stroke-width="2"/><rect x="36" y="26" width="12" height="16" rx="1" fill="#FF5722" opacity="0.3"/><circle cx="44" cy="34" r="1.5" fill="currentColor"/></svg>
                            </div>
                            <div class="quantity-label">Porte-fen√™tre</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="portefenetres">‚àí</button>
                                <input type="number" name="qty_portefenetres" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="portefenetres">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="baie">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="10" y="12" width="44" height="40" rx="3" fill="#FFE5E0" stroke="currentColor" stroke-width="2"/><rect x="12" y="14" width="19" height="36" fill="white" opacity="0.7"/><path d="M31 14v36" stroke="currentColor" stroke-width="2"/></svg>
                            </div>
                            <div class="quantity-label">Baie vitr√©e</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="baie">‚àí</button>
                                <input type="number" name="qty_baie" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="baie">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="porteentree">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="16" y="8" width="32" height="48" rx="3" fill="#FF8A65" stroke="currentColor" stroke-width="2"/><rect x="20" y="16" width="24" height="10" rx="1.5" fill="#FFE5E0"/><circle cx="40" cy="34" r="2" fill="white"/></svg>
                            </div>
                            <div class="quantity-label">Porte d'entr√©e</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="porteentree">‚àí</button>
                                <input type="number" name="qty_porteentree" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="porteentree">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="garage">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="10" y="10" width="44" height="44" rx="3" fill="#FF8A65" stroke="currentColor" stroke-width="2"/><path d="M10 20h44M10 26h44M10 32h44M10 38h44" stroke="#D84315" stroke-width="2"/></svg>
                            </div>
                            <div class="quantity-label">Garage</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="garage">‚àí</button>
                                <input type="number" name="qty_garage" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="garage">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="voletroulant">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="16" y="18" width="32" height="36" rx="2" fill="#FFE5E0" stroke="currentColor" stroke-width="2"/><rect x="18" y="10" width="28" height="10" rx="2" fill="#FF8A65" stroke="currentColor" stroke-width="2"/><path d="M18 24h28M18 28h28M18 32h28" stroke="#FF5722" stroke-width="1.5"/></svg>
                            </div>
                            <div class="quantity-label">Volet roulant</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="voletroulant">‚àí</button>
                                <input type="number" name="qty_voletroulant" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="voletroulant">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="voletbattant">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="8" y="12" width="20" height="40" rx="2" fill="#FF8A65" stroke="currentColor" stroke-width="2"/><rect x="36" y="12" width="20" height="40" rx="2" fill="#FF8A65" stroke="currentColor" stroke-width="2"/><path d="M10 20h16M38 20h16" stroke="#D84315" stroke-width="1.5"/></svg>
                            </div>
                            <div class="quantity-label">Volet battant</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="voletbattant">‚àí</button>
                                <input type="number" name="qty_voletbattant" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="voletbattant">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="portail">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="8" y="16" width="22" height="36" rx="2" fill="#FF8A65" stroke="currentColor" stroke-width="2"/><rect x="34" y="16" width="22" height="36" rx="2" fill="#FF8A65" stroke="currentColor" stroke-width="2"/></svg>
                            </div>
                            <div class="quantity-label">Portail</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="portail">‚àí</button>
                                <input type="number" name="qty_portail" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="portail">+</button>
                            </div>
                        </div>
                        <div class="quantity-item" data-type="pergola">
                            <div class="quantity-icon">
                                <svg viewBox="0 0 64 64" fill="none"><rect x="8" y="16" width="48" height="36" rx="3" fill="#FFE5E0" stroke="currentColor" stroke-width="2"/><line x1="8" y1="16" x2="8" y2="52" stroke="currentColor" stroke-width="3"/><line x1="56" y1="16" x2="56" y2="52" stroke="currentColor" stroke-width="3"/></svg>
                            </div>
                            <div class="quantity-label">Pergola</div>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn minus" data-target="pergola">‚àí</button>
                                <input type="number" name="qty_pergola" value="0" min="0" max="99" readonly>
                                <button type="button" class="qty-btn plus" data-target="pergola">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group"><input type="text" name="autreProjet" placeholder="Autre projet ?"></div>
                    <div class="step-error-message" id="step1Error">‚ö†Ô∏è S√©lectionnez au moins un √©l√©ment</div>
                </div>

                <div class="step" data-step="2">
                    <div class="step-indicator">2. Mat√©riaux</div>
                    <div class="form-group">
                        <div class="options-grid">
                            <label class="option-card">
                                <input type="checkbox" name="materiau_pvc" value="pvc">
                                <div class="icon">‚ö™</div>
                                <div class="title">PVC</div>
                            </label>
                            <label class="option-card">
                                <input type="checkbox" name="materiau_aluminium" value="aluminium">
                                <div class="icon">üîò</div>
                                <div class="title">Alu</div>
                            </label>
                            <label class="option-card">
                                <input type="checkbox" name="materiau_bois" value="bois">
                                <div class="icon">üå≥</div>
                                <div class="title">Bois</div>
                            </label>
                            <label class="option-card">
                                <input type="checkbox" name="materiau_mixte" value="mixte">
                                <div class="icon">üåó</div>
                                <div class="title">Mixte</div>
                            </label>
                            <label class="option-card">
                                <input type="checkbox" name="materiau_indecis" value="indecis">
                                <div class="icon">üí°</div>
                                <div class="title">Avis pro</div>
                            </label>
                        </div>
                    </div>
                    <div class="step-error-message" id="step2Error">‚ö†Ô∏è S√©lectionnez un mat√©riau</div>
                </div>

                <div class="step" data-step="3">
                    <div class="step-indicator">3. Bien</div>
                    <div class="form-group">
                        <select name="typeBien" required id="typeBienSelect">
                            <option value="">Type de bien ?</option>
                            <option value="maison">Maison</option>
                            <option value="appartement">Appartement</option>
                            <option value="local">Local pro</option>
                            <option value="neuf">Neuf</option>
                        </select>
                    </div>
                </div>

                <div class="step" data-step="4">
                    <div class="step-indicator">4. D√©lai</div>
                    <div class="form-group">
                        <select name="delai" required id="delaiSelect">
                            <option value="">Quand ?</option>
                            <option value="urgent">Urgent</option>
                            <option value="1-3mois">1-3 mois</option>
                            <option value="3-6mois">3-6 mois</option>
                            <option value="6mois+">+ 6 mois</option>
                        </select>
                    </div>
                </div>

                <div class="step" data-step="5">
                    <div class="step-indicator">5. D√©tails</div>
                    <div class="form-group">
                        <label>Code Postal *</label>
                        <input type="text" name="codePostal" id="codePostal" placeholder="74000" required pattern="[0-9]{5}" maxlength="5">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" placeholder="D√©tails..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Photos</label>
                        <div class="file-upload-wrapper" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
                            <div style="font-size:20px;">üì∏</div>
                            <div style="font-size:11px;color:#666">Ajouter photos</div>
                        </div>
                        <div class="uploaded-files" id="uploadedFiles"></div>
                    </div>
                </div>

                <div class="step" data-step="6">
                    <div class="step-indicator">6. Contact</div>
                    <div class="recap-section">
                        <div style="font-weight:700">R√©cap :</div>
                        <div id="recapContent"></div>
                        <span class="recap-edit" onclick="goToStep(1)">Modifier</span>
                    </div>
                    <div class="form-group"><input type="text" name="nom" id="nom" placeholder="Nom *" required></div>
                    <div class="form-group"><input type="text" name="prenom" id="prenom" placeholder="Pr√©nom *" required></div>
                    <div class="form-group"><input type="email" name="email" id="email" placeholder="Email *" required></div>
                    <div class="form-group"><input type="tel" name="telephone" id="telephone" placeholder="T√©l√©phone *" required pattern="[0-9]{10}" maxlength="10"></div>
                    <div style="display:flex;gap:10px;margin-top:10px">
                        <input type="checkbox" name="rgpd" id="rgpd" required style="width:16px;height:16px;">
                        <label for="rgpd" style="font-size:10px;font-weight:400;">J'accepte d'√™tre recontact√©.</label>
                    </div>
                    <div class="step-error-message" id="rgpdError">‚ö†Ô∏è Cochez la case</div>
                </div>

                <div class="step" data-step="7">
                    <div class="success-message">
                        <div class="success-icon"><svg fill="none" viewBox="0 0 24 24" style="stroke:white;stroke-width:3"><polyline points="20 6 9 17 4 12"/></svg></div>
                        <h2>Envoy√© !</h2>
                        <p>On vous recontacte tr√®s vite.</p>
                    </div>
                </div>

                <div class="buttons" id="navigationButtons">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Retour</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Continuer</button>
                </div>
            </form>

            <div class="form-footer">
                <div><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Rapide</div>
                <div>‚Ä¢</div>
                <div><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/></svg> Gratuit</div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const form = document.getElementById('devisForm');
            const steps = document.querySelectorAll('#saunier-form-container .step');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const navigationButtons = document.getElementById('navigationButtons');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            let currentStep = 1;
            const totalSteps = 6;
            let uploadedFiles = [];

            function sendHeightToParent() {
                if (window.parent !== window) {
                    const height = document.body.scrollHeight;
                    window.parent.postMessage({ type: 'resize-iframe', height: height }, '*');
                }
            }
            window.addEventListener('load', sendHeightToParent);
            const resizeObserver = new ResizeObserver(sendHeightToParent);
            resizeObserver.observe(document.getElementById('saunier-form-container'));

            window.goToStep = function(step) { currentStep = step; showStep(currentStep); };

            function showStep(step) {
                steps.forEach((s, index) => {
                    s.classList.remove('active');
                    if (index === step - 1) s.classList.add('active');
                });
                document.querySelectorAll('.step-error-message').forEach(msg => msg.style.display = 'none');
                prevBtn.style.display = step === 1 ? 'none' : 'block';
                
                if (step === totalSteps) {
                    nextBtn.textContent = 'Envoyer';
                    generateRecap();
                } else if (step > totalSteps) {
                    navigationButtons.style.display = 'none';
                    document.querySelector('.progress-container').style.display = 'none';
                } else {
                    nextBtn.textContent = 'Suivant';
                    navigationButtons.style.display = 'flex';
                }
                const percentage = Math.min(100, Math.round((step / totalSteps) * 100));
                progressBarFill.style.width = percentage + '%';
                progressText.textContent = percentage + '%';
                sendHeightToParent();
            }

            document.querySelectorAll('.qty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const target = this.dataset.target;
                    const input = form.querySelector(`input[name="qty_${target}"]`);
                    const item = input.closest('.quantity-item');
                    let val = parseInt(input.value);
                    if (this.classList.contains('plus') && val < 99) val++;
                    if (this.classList.contains('minus') && val > 0) val--;
                    input.value = val;
                    if (val > 0) item.classList.add('selected'); else item.classList.remove('selected');
                });
            });

            document.querySelectorAll('.option-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'INPUT') { const input = this.querySelector('input'); input.checked = !input.checked; }
                    const input = this.querySelector('input');
                    if(input.checked) this.classList.add('selected'); else this.classList.remove('selected');
                });
            });

            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                files.forEach(f => uploadedFiles.push(f));
                displayFiles();
            });
            function displayFiles() {
                document.getElementById('uploadedFiles').innerHTML = uploadedFiles.map((f,i) => 
                    `<div class="uploaded-file"><span>${f.name}</span><span style="color:red;cursor:pointer" onclick="removeFile(${i})">‚úï</span></div>`
                ).join('');
                sendHeightToParent();
            }
            window.removeFile = function(i) { uploadedFiles.splice(i, 1); displayFiles(); };

            function validateStep(step) {
                if (step === 1) {
                    let total = 0; form.querySelectorAll('input[name^="qty_"]').forEach(i => total += parseInt(i.value));
                    if (total === 0) { document.getElementById('step1Error').style.display = 'block'; sendHeightToParent(); return false; }
                }
                if (step === 2 && form.querySelectorAll('input[name^="materiau_"]:checked').length === 0) {
                    document.getElementById('step2Error').style.display = 'block'; sendHeightToParent(); return false;
                }
                if (step === 3 && !document.getElementById('typeBienSelect').value) return false;
                if (step === 4 && !document.getElementById('delaiSelect').value) return false;
                if (step === 5 && !document.getElementById('codePostal').checkValidity()) return false;
                if (step === 6) {
                    let valid = true;
                    ['nom', 'prenom', 'email', 'telephone'].forEach(id => { if(!document.getElementById(id).value) valid = false; });
                    if(!document.getElementById('rgpd').checked) { document.getElementById('rgpdError').style.display = 'block'; valid = false; }
                    return valid;
                }
                return true;
            }

            function generateRecap() {
                let html = '';
                const items = [];
                form.querySelectorAll('input[name^="qty_"]').forEach(i => {
                    if(parseInt(i.value) > 0) items.push(`${i.value}x ${i.closest('.quantity-item').querySelector('.quantity-label').innerText}`);
                });
                if(items.length) html += `<div class="recap-item">${items.join(', ')}</div>`;
                const cp = document.getElementById('codePostal').value;
                if(cp) html += `<div class="recap-item">CP: ${cp}</div>`;
                document.getElementById('recapContent').innerHTML = html;
            }

            nextBtn.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    if (currentStep < totalSteps) { currentStep++; showStep(currentStep); }
                    else { submitForm(); }
                }
            });
            prevBtn.addEventListener('click', function() { if (currentStep > 1) { currentStep--; showStep(currentStep); } });

            function submitForm() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                data.uploadedFiles = uploadedFiles;
                
                const materiaux = [];
                document.querySelectorAll('input[name^="materiau_"]:checked').forEach(input => { materiaux.push(input.value); });
                data.materiaux = materiaux.join(', ');

                if (data._honeypot) return; delete data._honeypot;

                const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwD2fDcuGUKI7EdUYnGj5KdIXQa0pesNHqcPUsEwLI4TQQyq1S7jy2Tp2dYOx9ZhW5r/exec';
                
                fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => { currentStep++; showStep(currentStep); })
                  .catch(() => { currentStep++; showStep(currentStep); });
            }
        })();
    </script>
</body>
</html>
